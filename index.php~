<?php
session_start();
ini_set('display_errors', 1);
error_reporting(E_ALL);


// Create connection



$redirect_uri = 'http://' . $_SERVER['HTTP_HOST'] . $_SERVER['PHP_SELF'];
include('ss.php');
require_once 'vendor/autoload.php';

use Aws\S3\S3Client;
use Aws\ElasticTranscoder\ElasticTranscoderClient;

$client = new Google_Client();
$client->setClientId($client_id);
$client->setClientSecret($client_secret);
$client->setRedirectUri($redirect_uri);
$client->setAccessType("offline");
$client->setScopes(array(
    'https://www.googleapis.com/auth/plus.stream.write',
    'https://www.googleapis.com/auth/plus.me',
    'https://www.googleapis.com/auth/userinfo.email',
 	'https://www.googleapis.com/auth/userinfo.profile',
 	'https://www.googleapis.com/auth/plus.login',
    
));




if (isset($_REQUEST['logout'])) {
    unset($_SESSION['upload_token']);
}

if (isset($_GET['code'])) {
    $token = $client->fetchAccessTokenWithAuthCode($_GET['code']);
    $client->setAccessToken($token);

// store in the session also
    $_SESSION['upload_token'] = $token;

// redirect back to the example
    header('Location: ' . filter_var($redirect_uri, FILTER_SANITIZE_URL));
}

if (!empty($_SESSION['upload_token'])) {
    $client->setAccessToken($_SESSION['upload_token']);
    if ($client->isAccessTokenExpired()) {
        unset($_SESSION['upload_token']);
    }
} else {
    $authUrl = $client->createAuthUrl();
}
//debug($_SESSION);
if ($client->getAccessToken()) {


//print_r('s');
    $t=$client->getAccessToken();
    //debug($client->refreshToken($t['access_token']));
    if ($client->isAccessTokenExpired()) {
        $client->refreshToken($t['access_token']);
        
    }


    
      $url = 'https://www.googleapis.com/plus/v1/people/me/?access_token=' . $t['access_token'] ;
//  Initiate curl
                $ch = curl_init();
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
               
                curl_setopt($ch, CURLOPT_URL, $url);
                $file_result = curl_exec($ch);
                curl_close($ch);
debug($file_result);



    exit;
}
?>
<div class="box">
<?php if (isset($authUrl)): ?>
        <div class="request">
            <a class='login' href='<?= $authUrl ?>'>Connect Me!</a>
        </div>


<?php endif ?>
</div>
